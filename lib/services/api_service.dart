// lib/api_service.dart

import 'dart:convert';
import 'package:http/http.dart' as http;

class ApiService {
  static const _apiKey =
      "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";
  static final _url =
      Uri.parse("https://openrouter.ai/api/v1/chat/completions");

  static Future<String> getRole(String message) async {
    const String systemPrompt =
        "ุชู ฺฉ ูุดุงูุฑ ูุชุฎุตุต ุฏุฑ ุฒููู ฑฒ ูุฏู ู ุทุฑุญูุงุฑูโูุง ูุณุช.\n"
        "ููุท ู ููุท ุฏุฑ ูุงูุจ ฺฉ JSON ุจุง ฺฉูุฏ \"emotion\" ูพุงุณุฎ ุจุฏูุ ุจู ุดฺฉู ุฒุฑ:\n"
        "{ \"emotion\": \"ุชุฑุณ\" }\n\n"
        "- ุฑูุฌุด ู ุฏูฺุฑฺฉู ุดุฏู\n"
        "- ุชุฑุณ\n"
        "- ุงุญุณุงุณ ฺฏูุงูุ ุดุฑู ู ุฎุฌุงูุช\n"
        "- ุบู ู ุงูุฏูู\n"
        "- ุงูุณุฑุฏฺฏ ู ูุงุงูุฏ\n\n"
        "ูฺ ุชูุถุญ ุง ูุชู ุงุถุงูู ูุฏู.";

    return await _postToModel(message, systemPrompt, 'emotion');
  }

  static Future<String> getSelfWill(String message, String role) async {
    const String selfWill = "ุฎุดู\n"
        "ูุงุตุงุฏู\n"
        "ุญุณุงุฏุช\n"
        "ูพุฑุฎูุฑ / ุงูุฑุงุท ุฏุฑ ุฎูุฑุฏู\n"
        "ุฎูุฏุจุฒุฑฺฏโุจู\n"
        "ุทูุน\n"
        "ุขุณุจ ุฑุณุงูุฏู\n"
        "ููุฑุช\n"
        "ุจโุตุจุฑ\n"
        "ุจโุชูุฌู ุจู ุฏฺฏุฑุงู\n"
        "ุชุนุตุจ / ุนุฏู ุชุญูู\n"
        "ุชูโูพุฑูุฑ\n"
        "ุดููุชโฺฏุฑุง\n"
        "ุบุฑูุฑ\n"
        "ุชุนูู / ุงููุงูโฺฉุงุฑ\n"
        "ุณุฑุฒูุด ุฎูุฏ\n"
        "ุญู ุจู ุฌุงูุจ ุจูุฏู\n"
        "ุชุฑุญู ุจู ุญุงู ุฎูุฏ\n"
        "ุฎูุฏูุญูุฑ\n"
        "ุจุฏุจู\n"
        "ุจโููุง";

    const String schemas = "ุฑูุงุดุฏฺฏ/ุจโุซุจุงุช\n"
        "ุจโุงุนุชูุงุฏ/ุจุฏุฑูุชุงุฑ\n"
        "ูุญุฑููุช ูุฌุงู\n"
        "ููุต/ุดุฑู\n"
        "ุงูุฒูุง ุงุฌุชูุงุน/ุจฺฏุงูฺฏ\n"
        "ูุงุจุณุชฺฏ/ุจโฺฉูุงุช\n"
        "ุขุณุจโูพุฐุฑ ูุณุจุช ุจู ุถุฑุฑ ุง ุจูุงุฑ\n"
        "ฺฏุฑูุชุงุฑ/ุฏุฑููโุชูุฏฺฏ\n"
        "ุดฺฉุณุช\n"
        "ุงุณุชุญูุงู/ุจุฒุฑฺฏโููุด\n"
        "ุฎูุฏููุงุฑฺฏุฑ ูุงฺฉุงู\n"
        "ุชุงุจุนุช\n"
        "ุงุซุงุฑฺฏุฑ\n"
        "ุชุงุฏุทูุจ/ุฌูุจ ุชูุฌู\n"
        "ูููโฺฏุฑุง/ุจุฏุจู\n"
        "ุจุงุฒุฏุงุฑ ูุฌุงู\n"
        "ุงุณุชุงูุฏุงุฑุฏูุง ุณุฎุชฺฏุฑุงูู/ุนุจโุฌู ุงูุฑุงุท\n"
        "ุชูุจูโฺฏุฑุง";
    const String systemPrompt =
        "ุชู ฺฉ ูุดุงูุฑ ูุชุฎุตุต ุฏุฑ ุฒููู ฑฒ ูุฏู ู ุทุฑุญูุงุฑูโูุง ูุงุณุงุฒฺฏุงุฑ ูุณุช.\n\n"
        "ูุงุฌุฑุง ุจุฑุงุช ุงุฑุณุงู ูโุดูุฏุ ุจู ููุฑุงู ุงุญุณุงุณ ฺฉู ฺฉุงุฑุจุฑ ุชุฌุฑุจู ฺฉุฑุฏู ุงุณุช.\n"
        "ูุธููโ ุชู ุงู ุงุณุช ฺฉู **ููุท ู ููุท ุงุฒ ูุณุช ฺฉุงูู ููุงูุต ููุฌูุฏ ุฏุฑ ูุชุบุฑ defects ูพุงุณุฎ ุจุฏู** ู ูุฑฺฉุฏุงู ุฑุง ุฏุฑ ฺฉ ุงุฒ ุณู ุฏุณุชูโ ุฒุฑ ูุฑุงุฑ ุฏู:\n\n"
        "- \"ูุฑุชุจุทโุชุฑูโูุง\": ููุงูุต ฺฉู ููุด ุงุตู ุง ูพุฑุฑูฺฏ ุฏุฑ ุดฺฉูโฺฏุฑ ุงู ูุงุฌุฑุง ุฏุงุดุชูโุงูุฏ.\n"
        "- \"ฺฉูโุงุฑุชุจุงุทโูุง\": ููุงูุต ฺฉู ุจู ุตูุฑุช ุฎูู ุง ุบุฑูุณุชูู ููฺฉู ุงุณุช ุชุฃุซุฑฺฏุฐุงุฑ ุจุงุดูุฏ.\n"
        "- \"ุจโุงุฑุชุจุงุทโูุง\": ููุงูุต ฺฉู ุจู ูฺ ุนููุงู ุจุง ูุงุฌุฑุง ูุฑุชุจุท ูุณุชูุฏ.\n\n"
        "๐ด ููู: ุชู ุจุงุฏ **ุชูุงู ููุงูุต ููุฌูุฏ ุฏุฑ ูุณุช defects ุฑุง ุจูโุตูุฑุช ฺฉุงูู ุจุฑุฑุณ ฺฉุฑุฏู ู ุญุชูุงู ุฏุฑ ฺฉ ุงุฒ ุณู ุฏุณุชูโ ุจุงูุง ูุฑุงุฑ ุฏู. ูฺ ููุต ูุจุงุฏ ุงุฒ ููู ุจูุชุฏ. ููฺูู ุงุฒ ูฺ ููุฑุฏ ุฎุงุฑุฌ ุงุฒ ุงู ูุณุช ุงุณุชูุงุฏู ูฺฉู.**\n\n"
        "ุจุฑุง ูุฑ ููุต ฺฉู ุฏุฑ ุฏุณุชูโ ยซูุฑุชุจุทโุชุฑูโูุงยป ุง ยซฺฉูโุงุฑุชุจุงุทโูุงยป ูุฑุงุฑ ูโฺฏุฑุฏุ ฺฉ ุชุญูู ุจุณุงุฑ ฺฉูุชุงู ุจููุณ (ฑ ุชุง ฒ ุฌููู) ฺฉู ุชูุถุญ ุฏูุฏ ุงู ููุต ฺฺฏููู ุฏุฑ ูุงุฌุฑุง ููุด ุฏุงุดุชู ุงุณุช.\n"
        "ุฏุณุชูโ ยซุจโุงุฑุชุจุงุทโูุงยป ููุท ุดุงูู ูุงู ููุตโูุงุณุช ู ูุงุฒ ุจู ุชุญูู ูุฏุงุฑุฏ.\n\n"
        "๐ ููุท ู ููุท ฺฉ ุดุก JSON ุฎุงูุต ุจุฏู. ูฺ ุชูุถุญ ุงุถุงููโุงุ ูฺ ุนุจุงุฑุช ูุชูุ ู ูฺ ูุงูุจโุจูุฏ ูุงููุฏ ```json ุง '''json ุง code block ูููุณ.\n\n"
        "ูุฑูุช ุฏูู ูพุงุณุฎ ุจุงุฏ ุจู ุดฺฉู ุฒุฑ ุจุงุดุฏ:\n"
        "{\n"
        "  \"ูุฑุชุจุทโุชุฑูโูุง\": [[\"ุงุณู ููุต ฑ\", \"ุชุญูู ฺฉูุชุงู\"]],\n"
        "  \"ฺฉูโุงุฑุชุจุงุทโูุง\": [[\"ุงุณู ููุต ฒ\", \"ุชุญูู ฺฉูุชุงู\"]],\n"
        "  \"ุจโุงุฑุชุจุงุทโูุง\": [\"ุงุณู ููุต ณ\", \"ุงุณู ููุต ด\"]\n"
        "}\n\n"
        "## ูุณุช ฺฉุงูู ููุงูุต (defects):\n"
        "$selfWill";

    final String userPromp = "ูุงุฌุฑุง\n"
        "$message \n"
        "ููุด\n"
        "$role";

    return await _postToModel(userPromp, systemPrompt, 'response');
  }

  // ุชุงุจุน ูุดุชุฑฺฉ ุจุฑุง ูุฑุณุชุงุฏู ุฏุงุฏู ุจู ูุฏู
  static Future<String> _postToModel(
      String message, String systemPrompt, String fieldName) async {
    final data = {
      "model": "deepseek/deepseek-r1-0528:free",
      "messages": [
        {"role": "system", "content": systemPrompt},
        {"role": "user", "content": message}
      ]
    };

    try {
      final response = await http.post(
        _url,
        headers: {
          'Content-Type': 'application/json',
          "Authorization": 'Bearer $_apiKey',
        },
        body: jsonEncode(data),
      );

      if (response.statusCode == 200) {
        final decoded = utf8.decode(response.bodyBytes);
        final json = jsonDecode(decoded);
        final content = json['choices'][0]['message']['content'];
        // final resultJson = jsonDecode(content);
        return '$content';
      } else {
        return 'ุฎุทุง ุฏุฑ ุงุฑุณุงู: ${response.statusCode}';
      }
    } catch (e) {
      return 'ุฎุทุง ุฏุฑ ุงุฑุชุจุงุท ุจุง ุณุฑูุฑ';
    }
  }
}
